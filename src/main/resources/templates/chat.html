<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>채팅 | BizBeacon for Boss</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link th:href="@{/css/header.css}" rel="stylesheet"/>
    <link th:href="@{/css/footer.css}" rel="stylesheet"/>
    <link th:href="@{/css/chat.css}" rel="stylesheet"/>
    <!-- 내부 CSS 옮김 -->
</head>
<body>

<!-- Header -->
<div th:replace="partials/logined-header :: logined-header"></div>

<main class="container my-4">
    <div class="chat-container">

        <!--
          [채팅 페이지 처리 흐름]

          1. 진입 경로
             - 첫 페이지 배너, 상단 탭 → /chat
             - 식당 상세 → /chat?partnerId={상대ID}

          2. 백엔드 로직
             - partnerId가 있으면:
                 - 기존 채팅방 있으면 해당 메시지 로드
                 - 없으면 새 채팅방 생성 후 메시지 로드
             - partnerId 없으면 내 채팅방 목록만 표시

          3. 메시지 렌더링
             - messages 테이블에서 senderId 확인
             - senderId == session.user.id → 오른쪽(me)
             - senderId != session.user.id → 왼쪽(other)

          4. 메시지 전송/수신
             - WebSocket /ws/chat 연결
             - 메시지 전송 시 DB 저장 후 브로드캐스트
             - 새 메시지 들어오면 해당 채팅방 목록을 최상단으로 정렬
             - unreadCount 증가/초기화 처리

          5. 토글 기능
             - "읽지 않은 항목" 체크 시 → unreadCount > 0 인 채팅방만 필터링
             - 해제 시 → 전체 채팅방 표시
        -->

        <!-- 채팅방 목록 -->
        <div class="chat-list">
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                <h6 class="mb-0">
                    <strong th:text="${user != null ? user.nickName : '게스트'}">myId</strong>
                </h6>

                <!-- 읽지 않은 메시지 수 + 토글 버튼-->
                <div class="d-flex align-items-center gap-2 unread-toggle-wrap">
                    <label for="unreadToggle" class="d-flex align-items-center mb-0 small">
                        안읽음
                        <span id="totalUnreadCountBadge"
                              class="badge bg-danger ms-1"
                              th:text="${totalUnreadCount}"
                              th:style="${totalUnreadCount > 0 ? '' : 'display: none;'}">1</span>
                    </label>

                    <div class="form-check form-switch m-0 p-0">
                        <input class="form-check-input unread-toggle-input" type="checkbox" id="unreadToggle">
                    </div>
                </div>

            </div>

            <!-- 최근 메시지 순 정렬-->
            <div id="chatListContent">
                <div th:each="room : ${chatRooms}"
                     class="chat-list-item"
                     th:id="'chat-room-' + ${room.id}" th:data-unread-count="${room.unreadCount}"
                     th:onclick="'location.href=\'/chat/' + ${room.id} + '\''">
                    <img th:src="${room.partnerProfileUrl != null ? room.partnerProfileUrl : '/images/default-profile.png'}"
                         alt="상대방 사진">

                    <div style="flex-grow: 1; margin-right: 10px;">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <strong th:text="${room.partnerNickName}">상대방 닉네임</strong>
                            <small class="last-message-time"
                                   th:text="${#temporals.format(room.lastMessageCreatedAt, 'HH:mm')}"
                                   style="color: #6c757d; font-size: 11px;"></small>
                        </div>
                        <small class="last-message-content" th:text="${room.lastMessage}" style="color: #6c757d;">최근
                            메시지</small>
                    </div>

                    <span class="unread-badge unread" th:if="${room.unreadCount > 0}"
                          th:text="${room.unreadCount}">1</span>
                </div>
            </div>
        </div>

        <div th:if="${partnerInfo != null}" class="chat-room">
            <div class="chat-header">
                <img th:src="${partnerInfo.partnerProfileUrl != null ? partnerInfo.partnerProfileUrl : '/images/default-profile.png'}"
                     alt="상대방 사진">

                <div>
                    <strong th:text="${partnerInfo.partnerNickName}">상대방 아이디</strong><br>
                </div>
            </div>

            <div class="messages" id="messageArea">
                <div th:each="msg : ${messages}" class="message"
                     th:classappend="${msg.senderId == user.id} ? ' me' : ' other'">
                    <div>
                        <div class="message-content" th:text="${msg.content}">메시지 내용</div>
                        <div class="message-time" th:text="${#temporals.format(msg.createdAt, 'HH:mm')}">오전 9:00</div>
                    </div>
                </div>
            </div>

            <form id="chatForm" class="message-input">
                <textarea id="message" placeholder="메시지를 입력해주세요" class="form-control"></textarea>
                <button type="submit" class="btn btn-primary">전송</button>
            </form>
        </div>

        <div th:if="${partnerInfo == null}" class="chat-room"
             style="justify-content: center; align-items: center; font-size: 1.2rem; color: #6c757d; border-left: 1px solid #dee2e6;">
            <p>채팅방을 선택해주세요.</p>
        </div>
    </div>

    <!--    stomp -->
    <div id="stomp-vars"
         th:data-user-id="${user != null ? user.id : ''}"
         th:data-room-id="${partnerInfo != null ? partnerInfo.id : ''}">
    </div>

    <div id="user-info-vars"
         th:data-user-id="${user != null ? user.id : ''}"></div>
</main>

<!-- Footer -->
<div th:replace="partials/footer :: footer"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    var stompClient = null;
    var currentRoomId = null;
    var currentUserId = null;

    // 날짜 포매팅 함수
    function formatDateTime(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        // 날짜가 유효하지 않으면
        if (isNaN(date)) return '';

        // 월, 일 필요하면 사용
        // const month = ('0' + (date.getMonth() + 1)).slice(-2);
        // const day = ('0' + date.getDate()).slice(-2);
        const hours = ('0' + date.getHours()).slice(-2);
        const minutes = ('0' + date.getMinutes()).slice(-2);

        return `${hours}:${minutes}`;
    }

    $(document).ready(function () {
        // 먼저 userId 가져오기 - chatList만 보여주는 상황에서도 비동기 연결(/chat 에서)
        var $userInfoVars = $('#user-info-vars');
        currentUserId = $userInfoVars.data('userId');

        // stomp 관련 변수
        var $stompVars = $('#stomp-vars');
        currentRoomId = $stompVars.data('roomId') || null;

        // 로그 좀 찍어봄
        console.log("✅ chat script 실행됨");
        console.log("user:", currentUserId, "room:", currentRoomId);

        // 채팅방이 없어도 stomp 연결 시작
        if (currentUserId) {
            connect(); // 모든 로그인 사용자에게 STOMP 연결
        }

        // 채팅방 페이지만 실행
        if ($('#messageArea').length > 0) {
            scrollToBottom();

            if (currentRoomId && currentUserId) {
                markAllAsRead(currentRoomId, currentUserId);
            }

            $('#message').on('input', autoResizeTextarea);
            autoResizeTextarea();

            $('#chatForm').on('submit', function (e) {
                e.preventDefault();
                sendMessage();
            });

            $('#message').on('keydown', function (e) {
                if (e.keyCode === 13 && !e.shiftKey) {
                    e.preventDefault();
                    $('#chatForm').submit();
                }
            });
        }

        // 최초 로드 시 채팅 목록 갱신
        if (!currentRoomId && $('#chatListContent').length > 0 && currentUserId) {
            console.log('최초 목록 로드를 위해 updateChatList 호출');
            updateChatList();
        }

        // 읽지 않은 메시지 토글 이벤트
        $('#unreadToggle').on('change', handleUnreadToggle);
    });

    // 텍스트 에리아 동적 높이 조절 함수
    function autoResizeTextarea() {
        const $textarea = $('#message');
        // 최소 높이로 높이를 초기화
        $textarea.css('height', 'auto');

        // scrollHeight가 max-height보다 크면 스크롤 생성
        const scrollHeight = $textarea[0].scrollHeight;

        // min-height보다 크고 max-height보다 작은 경우에만 동적으로 높이 조절
        const maxHeight = 100;

        if (scrollHeight > maxHeight) {
            // 최대 높이를 초과하면 100px로 고정 + 스크롤 발생
            $textarea.css('height', maxHeight + 'px');
        } else {
            // 최대 높이 미만이면 내용에 맞게 높이 설정
            $textarea.css('height', scrollHeight + 'px');
        }
    }

    // 읽지 않은 메시지 토글 기능
    function handleUnreadToggle() {
        const isChecked = $(this).prop('checked');
        const $roomItems = $('#chatListContent').find('.chat-list-item');

        $roomItems.each(function () {
            const $item = $(this);
            const unreadCount = parseInt($item.attr('data-unread-count')) || 0;

            if (isChecked) {
                if (unreadCount === 0) {
                    $item.hide(); // 안 읽은 메시지가 0개면 숨김
                } else {
                    $item.show();
                }
            } else {
                $item.show(); // 토글 해제 시 모두 보임
            }
        });
    }

    // 읽음 처리 메서드
    function markAllAsRead(roomId, userId) {
        $.ajax({
            type: 'PUT',
            url: `/api/chat/messages/read/${roomId}?bossId=${userId}`,
            contentType: 'application/json'
        }).done(function () {
            console.log(`[READ] Room ${roomId}: All unread messages marked as read.`);
            updateChatList();
        }).fail(function (error) {
            console.error('[READ ERROR]', error);
        });
    }

    // 연결 함수
    function connect() {
        // WebSocketConfig에 지정한 sockjs 엔드포인트 /chatting
        var socket = new SockJS("/chatting");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // 채팅방이 있을 때
            if (currentRoomId) {
                var subscriptionUrl = `/topic/${currentRoomId}`;
                // 구독 경로: /topic/{roomId}
                stompClient.subscribe(subscriptionUrl, function (message) {
                    showMessage(JSON.parse(message.body));
                });
            }

            // 채팅 목록 업데이트 구독 경로
            var chatListUpdateUrl = `/topic/user/${currentUserId}/chatlist-update`;
            stompClient.subscribe(chatListUpdateUrl, function (notification) {
                // 알림을 받으면 채팅 목록을 갱신하는 함수 호출
                handleChatListUpdate(JSON.parse(notification.body));
            });
        }, function (error) {
            console.error('STOMP Error: ' + error);
        });
    }

    // 서버로 메시지 전송
    // db 전송 & stomp 서버로 전송
    function sendMessage() {
        const messageInput = $('#message');
        if (messageInput.length === 0) return;

        var content = messageInput.val().trim();
        if (!content || !stompClient || !currentRoomId || !currentUserId) return;

        var chatMessage = {
            // MessageDto와 비교
            'chatRoomId': currentRoomId,
            'senderId': currentUserId,
            'content': content
        };

        // 메시지 전송 경로
        var destinationUrl = `/api/chat/${currentRoomId}`;

        // send(destination, 헤더, 페이로드)
        stompClient.send(destinationUrl, {}, JSON.stringify(chatMessage));

        // 입력창 초기화, 리스트 비동기 갱신
        messageInput.val('');
        autoResizeTextarea(); // 입력창 크기 초기화

        // 첫 채팅 시에 연결이 디비보다 빨라서 내 기록이 안보임
        // 그래서 지연을 넣어줌
        setTimeout(updateChatList, 300);
    }

    // 개별 메시지 읽음 처리
    function markIndividualMessageAsRead(messageId) {
        $.ajax({
            type: 'PUT',
            url: `/api/chat/message/read/${messageId}`,
            contentType: 'application/json'
        }).done(function () {
            console.log(`[READ] Message ID ${messageId} marked as read.`);
        }).fail(function (error) {
            console.error('[READ ERROR]', error);
        });
    }

    // 수신된 메시지를 화면에 표시
    function showMessage(message) {
        // message 객체
        var isMe = (message.senderId == currentUserId);
        var messageClass = isMe ? 'me' : 'other';
        var time = new Date(message.createdAt);
        var formattedTime = ('0' + time.getHours()).slice(-2) + ':' + ('0' + time.getMinutes()).slice(-2);

        var messageHtml = `
            <div class="message ${messageClass}">
                <div>
                    <div class="message-content">${message.content}</div>
                    <div class="message-time">${formattedTime}</div>
                </div>
            </div>
        `;

        if (message.id && message.senderId !== currentUserId) {
            // 개별 메시지 읽음 처리
            markIndividualMessageAsRead(message.id);
        }

        var $messageArea = $('#messageArea');
        $messageArea.append(messageHtml);

        // 스크롤을 맨 아래로 이동
        scrollToBottom();
    }

    // 채팅 목록 UI 갱신 처리
    function handleChatListUpdate(notification) {
        console.log("[ChatList Update] 알림 수신:", notification);
        // AJAX 갱신 함수 호출
        updateChatList();
    }

    // 채팅방 목록 비동기 업데이트 - ajax 비동기 연결 사용
    function updateChatList() {
        if (!currentUserId) return;
        console.log('dom 재활용을 생활화합시다');

        $.ajax({
            type: 'GET',
            url: `/api/chat/list/${currentUserId}`,
            success: function (chatRooms) {
                const $chatListContent = $('#chatListContent');
                if ($chatListContent.length === 0) return;

                let totalUnreadCount = 0;
                // dom에 존재하는 모든 채팅방 id 저장
                const isUnreadChecked = $('#unreadToggle').prop('checked');
                const receivedRoomIds = new Set();

                // 새로운 순서대로 dom을 업데이트
                chatRooms.forEach(room => {
                    const roomId = room.id;
                    receivedRoomIds.add(roomId);
                    totalUnreadCount += room.unreadCount;

                    let $roomItem = $(`#chat-room-${roomId}`);

                    // DOM에 있는 경우
                    // 내용 업데이트 및 재정렬
                    if ($roomItem.length) {
                        // 텍스트/시간/데이터 속성 업데이트 (이미지 깜빡임 방지)
                        $roomItem.find('.last-message-content').text(room.lastMessage || '');
                        $roomItem.find('.last-message-time').text(formatDateTime(room.lastMessageCreatedAt));
                        $roomItem.attr('data-unread-count', room.unreadCount);

                        // 안 읽은 메시지 뱃지 업데이트
                        let $badge = $roomItem.find('.unread-badge');
                        if (room.unreadCount > 0) {
                            if ($badge.length === 0) {
                                // 뱃지가 없으면 새로 생성 후 추가 (스타일링은 chat.css에서 처리)
                                $badge = $(`<span class="unread-badge unread">${room.unreadCount}</span>`);
                                $roomItem.append($badge);
                            } else {
                                $badge.text(room.unreadCount).show();
                            }
                        } else {
                            $badge.hide();
                        }

                        // **[핵심]** 최신 순서로 재정렬: DOM의 맨 뒤로 이동시킵니다.
                        $roomItem.appendTo($chatListContent);

                        // 토글 상태에 따른 보이기/숨기기 적용
                        if (isUnreadChecked && room.unreadCount === 0) {
                            $roomItem.hide();
                        } else {
                            $roomItem.show();
                        }
                    }
                    // 2. 새로운 채팅방인 경우: DOM을 생성하여 추가
                    else {
                        const partnerProfileUrl = room.partnerProfileUrl || '/images/default-profile.png';
                        const unreadCountHtml = room.unreadCount > 0 ? `<span class="unread-badge unread">${room.unreadCount}</span>` : '';
                        const isHidden = isUnreadChecked && room.unreadCount === 0;

                        const newRoomHtml = `
                        <div class="chat-list-item"
                             id="chat-room-${roomId}"
                             data-unread-count="${room.unreadCount}"
                             onclick="location.href='/chat/${roomId}'"
                             style="${isHidden ? 'display: none;' : ''}">
                            <img src="${partnerProfileUrl}" alt="상대방 사진">
                            <div style="flex-grow: 1; margin-right: 10px;">
                                <div class="d-flex justify-content-between align-items-center w-100">
                                    <strong>${room.partnerNickName}</strong>
                                    <small class="last-message-time" style="color: #6c757d; font-size: 11px;">
                                        ${formatDateTime(room.lastMessageCreatedAt)}
                                    </small>
                                </div>
                                <small class="last-message-content" style="color: #6c757d;">${room.lastMessage || ''}</small>
                            </div>
                            ${unreadCountHtml}
                        </div>
                    `;
                        // 목록의 맨 뒤에 추가
                        $chatListContent.append(newRoomHtml);
                    }
                });

                // 3. (선택적) 서버에서 받지 못한 채팅방 삭제 (방 나가기 기능 시 필요)
                // 현재 DOM에 있지만 receivedRoomIds에 없는 항목은 삭제
                $chatListContent.find('.chat-list-item').each(function () {
                    const currentId = parseInt($(this).attr('id').replace('chat-room-', ''));
                    if (!receivedRoomIds.has(currentId)) {
                        $(this).remove();
                    }
                });

                // 안 읽은 메시지 수 업데이트
                updateTotalUnreadCountBadge(totalUnreadCount);
            },
            error: function (error) {
                console.error('[AJAX Reload ERROR]', error);
            }
        });
    }

    // 안 읽은 메시지 수 업데이트
    function updateTotalUnreadCountBadge(count) {
        const $badge = $('#totalUnreadCountBadge');
        const $label = $('#unreadToggleLabel');

        // 안읽음 텍스트와 안읽은 메시지 수가 같이 보임
        if (count > 0) {
            $badge.text(count).show();
            $label.show();
        } else {
            // 카운트 0이면 숨김
            $badge.hide();
            $label.hide();
        }
    }

    // 스크롤 아래로 내려주는 함수
    function scrollToBottom() {
        var $messageArea = $('#messageArea');

        if ($messageArea.length) {
            $messageArea.scrollTop($messageArea[0].scrollHeight);
        }
    }
</script>
</body>
</html>
