<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>채팅 | BizBeacon for Boss</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link th:href="@{/css/header.css}" rel="stylesheet"/>
    <link th:href="@{/css/footer.css}" rel="stylesheet"/>
    <link th:href="@{/css/chat.css}" rel="stylesheet"/>
    <!-- 내부 CSS 옮김 -->
</head>
<body>

<!-- Header -->
<div th:replace="partials/logined-header :: logined-header"></div>

<main class="container my-4">
    <div class="chat-container">

        <!--
          [채팅 페이지 처리 흐름]

          1. 진입 경로
             - 첫 페이지 배너, 상단 탭 → /chat
             - 식당 상세 → /chat?partnerId={상대ID}

          2. 백엔드 로직
             - partnerId가 있으면:
                 - 기존 채팅방 있으면 해당 메시지 로드
                 - 없으면 새 채팅방 생성 후 메시지 로드
             - partnerId 없으면 내 채팅방 목록만 표시

          3. 메시지 렌더링
             - messages 테이블에서 senderId 확인
             - senderId == session.user.id → 오른쪽(me)
             - senderId != session.user.id → 왼쪽(other)

          4. 메시지 전송/수신
             - WebSocket /ws/chat 연결
             - 메시지 전송 시 DB 저장 후 브로드캐스트
             - 새 메시지 들어오면 해당 채팅방 목록을 최상단으로 정렬
             - unreadCount 증가/초기화 처리

          5. 토글 기능
             - "읽지 않은 항목" 체크 시 → unreadCount > 0 인 채팅방만 필터링
             - 해제 시 → 전체 채팅방 표시
        -->

        <!-- 채팅방 목록 -->
        <div class="chat-list">
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                <h6 class="mb-0"><strong
                        th:text="${user != null ? user.nickName : '게스트'}">myId</strong>
                    <!-- 읽지 않은 메시지 수-->
                    <span id="totalUnreadCountBadge"
                          class="badge bg-danger ms-2"
                          th:text="${totalUnreadCount}"
                          th:style="${totalUnreadCount > 0 ? '' : 'display: none;'}">0</span>

                </h6>
                <div class="form-check form-switch d-flex align-items-center">
                    <label class="form-check-label small me-2" for="unreadToggle">읽지 않은 항목</label>
                    <!-- 읽지 않은 메시지 수 roomm.unreadCount-->
                    <input class="form-check-input" type="checkbox" id="unreadToggle">
                </div>
            </div>

            <!-- 최근 메시지 순 정렬-->
            <div id="chatListContent">
                <div th:each="room : ${chatRooms}"
                     class="chat-list-item"
                     th:id="'chat-room-' + ${room.id}" th:data-unread-count="${room.unreadCount}"
                     th:onclick="'location.href=\'/chat/' + ${room.id} + '\''">
                    <img th:src="${room.partnerProfileUrl != null ? room.partnerProfileUrl : '/images/default-profile.png'}"
                         alt="상대방 사진">

                    <div style="flex-grow: 1; margin-right: 10px;">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <strong th:text="${room.partnerNickName}">상대방 닉네임</strong>
                            <small class="last-message-time"
                                   th:text="${#temporals.format(room.lastMessageCreatedAt, 'HH:mm')}"
                                   style="color: #6c757d; font-size: 11px;"></small>
                        </div>
                        <small class="last-message-content" th:text="${room.lastMessage}" style="color: #6c757d;">최근
                            메시지</small>
                    </div>

                    <span class="unread-badge unread" th:if="${room.unreadCount > 0}"
                          th:text="${room.unreadCount}">1</span>
                </div>
            </div>
        </div>

        <div th:if="${partnerInfo != null}" class="chat-room">
            <div class="chat-header">
                <img th:src="${partnerInfo.partnerProfileUrl != null ? partnerInfo.partnerProfileUrl : '/images/default-profile.png'}"
                     alt="상대방 사진">

                <div>
                    <strong th:text="${partnerInfo.partnerNickName}">상대방 아이디</strong><br>
                </div>
            </div>

            <div class="messages" id="messageArea">
                <div th:each="msg : ${messages}" class="message"
                     th:classappend="${msg.senderId == user.id} ? ' me' : ' other'">
                    <div>
                        <div class="message-content" th:text="${msg.content}">메시지 내용</div>
                        <div class="message-time" th:text="${#temporals.format(msg.createdAt, 'HH:mm')}">오전 9:00</div>
                    </div>
                </div>
            </div>

            <form id="chatForm" class="message-input">
                <input type="text" id="message" placeholder="메시지를 입력해주세요" class="form-control">
                <button type="submit" class="btn btn-primary">전송</button>
            </form>
        </div>

        <div th:if="${partnerInfo == null}" class="chat-room"
             style="justify-content: center; align-items: center; font-size: 1.2rem; color: #6c757d; border-left: 1px solid #dee2e6;">
            <p>채팅방을 선택해주세요.</p>
        </div>
    </div>

    <!--    stomp -->
    <div th:if="${partnerInfo != null}">
        <div id="stomp-vars"
             th:with="room=${partnerInfo}"
             th:data-user-id="${user.id}"
             th:data-room-id="${room.id}"></div>
    </div>
</main>

<!-- Footer -->
<div th:replace="partials/footer :: footer"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    var stompClient = null;
    var currentRoomId = null;
    var currentUserId = null;

    // 날짜 포매팅 함수
    function formatDateTime(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        // 날짜가 유효하지 않으면
        if (isNaN(date)) return '';

        // const month = ('0' + (date.getMonth() + 1)).slice(-2);
        // const day = ('0' + date.getDate()).slice(-2);
        const hours = ('0' + date.getHours()).slice(-2);
        const minutes = ('0' + date.getMinutes()).slice(-2);

        return `${hours}:${minutes}`;
    }

    $(document).ready(function () {
        // Thymeleaf에서 서버 데이터 가져오기
        var $stompVars = $('#stomp-vars');

        // stomp가 있으면 -> 밑으로 보냄 -> 연결
        if ($stompVars.length > 0) {
            currentUserId = $stompVars.data('userId');
            currentRoomId = $stompVars.data('roomId');
            scrollToBottom();
            connect();

            if (currentRoomId && currentUserId) {
                markAllAsRead(currentRoomId, currentUserId);
            }
        }

        const initialCount = parseInt($('#totalUnreadCountBadge').text()) || 0;
        updateTotalUnreadCountBadge(initialCount);

        $('#chatForm').on('submit', function (e) {
            e.preventDefault();
            sendMessage();
        });

        // 읽지 않은 메시지 토글 이벤트
        $('#unreadToggle').on('change', handleUnreadToggle);
    });

    // 읽지 않은 메시지 토글 기능
    function handleUnreadToggle() {
        const isChecked = $(this).prop('checked');
        const $roomItems = $('#chatListContent').find('.chat-list-item');

        $roomItems.each(function () {
            const $item = $(this);
            const unreadCount = parseInt($item.attr('data-unread-count')) || 0;

            if (isChecked) {
                if (unreadCount === 0) {
                    $item.hide(); // 안 읽은 메시지가 0개면 숨김
                } else {
                    $item.show();
                }
            } else {
                $item.show(); // 토글 해제 시 모두 보임
            }
        });
    }

    // 읽음 처리 메서드
    function markAllAsRead(roomId, userId) {
        $.ajax({
            type: 'PUT',
            url: `/api/chat/messages/read/${roomId}?bossId=${userId}`,
            contentType: 'application/json'
        }).done(function () {
            console.log(`[READ] Room ${roomId}: All unread messages marked as read.`);
            updateChatList();
        }).fail(function (error) {
            console.error('[READ ERROR]', error);
        });
    }

    // 연결 함수
    function connect() {
        // WebSocketConfig에 지정한 sockjs 엔드포인트 /chatting
        var socket = new SockJS("/chatting");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // 구독 경로: /topic/{roomId}
            var subscriptionUrl = `/topic/${currentRoomId}`;
            stompClient.subscribe(subscriptionUrl, function (message) {
                showMessage(JSON.parse(message.body));
            });

            // 채팅 목록 업데이트 구독 경로
            var chatListUpdateUrl = `/topic/user/${currentUserId}/chatlist-update`;
            stompClient.subscribe(chatListUpdateUrl, function (notification) {
                // 알림을 받으면 채팅 목록을 갱신하는 함수 호출
                handleChatListUpdate(JSON.parse(notification.body));
            });
        }, function (error) {
            console.error('STOMP Error: ' + error);
        });
    }

    // 서버로 메시지 전송
    // db 전송 & stomp 서버로 전송
    function sendMessage() {
        var messageInput = $('#message');
        var content = messageInput.val().trim();

        if (content && stompClient && currentRoomId && currentUserId) {
            var chatMessage = {
                // MessageDto와 비교
                'chatRoomId': currentRoomId,
                'senderId': currentUserId,
                'content': content
            };

            // 메시지 전송 경로
            var destinationUrl = `/api/chat/${currentRoomId}`;

            // send(destination, 헤더, 페이로드)
            stompClient.send(destinationUrl, {}, JSON.stringify(chatMessage));

            // 입력창 초기화, 리스트 비동기 갱신
            messageInput.val('');
            updateChatList();
        }
    }

    // 개별 메시지 읽음 처리
    function markIndividualMessageAsRead(messageId) {
        $.ajax({
            type: 'PUT',
            url: `/api/chat/message/read/${messageId}`,
            contentType: 'application/json'
        }).done(function () {
            console.log(`[READ] Message ID ${messageId} marked as read.`);
        }).fail(function (error) {
            console.error('[READ ERROR]', error);
        });
    }

    // 수신된 메시지를 화면에 표시
    function showMessage(message) {
        // message 객체
        var isMe = (message.senderId == currentUserId);
        var messageClass = isMe ? 'me' : 'other';
        var time = new Date(message.createdAt);
        var formattedTime = ('0' + time.getHours()).slice(-2) + ':' + ('0' + time.getMinutes()).slice(-2);

        var messageHtml = `
            <div class="message ${messageClass}">
                <div>
                    <div class="message-content">${message.content}</div>
                    <div class="message-time">${formattedTime}</div>
                </div>
            </div>
        `;

        if (message.id && message.senderId !== currentUserId) {
            // 개별 메시지 읽음 처리
            markIndividualMessageAsRead(message.id);
        }

        var $messageArea = $('#messageArea');
        $messageArea.append(messageHtml);

        // 스크롤을 맨 아래로 이동
        scrollToBottom();
    }

    // 채팅 목록 UI 갱신 처리
    function handleChatListUpdate(notification) {
        console.log("[ChatList Update] 알림 수신:", notification);
        // AJAX 갱신 함수 호출
        updateChatList();
    }

    // 채팅방 목록 비동기 업데이트
    function updateChatList() {
        // 아니면 나가
        if (!currentUserId) return;

        $.ajax({
            type: 'GET',
            url: `/api/chat/list/${currentUserId}`,
            success: function (chatRooms) {
                const $chatListContent = $('#chatListContent');
                let totalUnreadCount = 0;

                chatRooms.forEach(room => {
                    const $roomItem = $(`#chat-room-${room.id}`); // 채팅방의 DOM 아이템 찾기
                    totalUnreadCount += room.unreadCount;

                    if ($roomItem.length) {
                        // 이미지 깜빡이는 걸 막기 위해 업데이트 형식으로 변환
                        $roomItem.find('.last-message-content').text(room.lastMessage);
                        $roomItem.find('.last-message-time').text(formatDateTime(room.lastMessageCreatedAt));
                        $roomItem.attr('data-unread-count', room.unreadCount); // 안읽음 토글 기능을 위해 데이터 업데이트

                        // 안 읽은 메시지 수 뱃지 업데이트
                        let $badge = $roomItem.find('.unread-badge');
                        if (room.unreadCount > 0) {
                            if ($badge.length === 0) {
                                // 뱃지가 없는 경우 새로 생성
                                $badge = $(`<span class="unread-badge unread" style="margin-top: 5px;">${room.unreadCount}</span>`);
                                $roomItem.append($badge);
                            } else {
                                $badge.text(room.unreadCount).show();
                            }
                        } else {
                            // 뱃지가 있고 카운트가 0이면 숨김
                            $badge.hide();
                        }

                        // 추가
                        $roomItem.appendTo($chatListContent);

                        // 토글 상태에 따른 보이기/숨기기 적용
                        if ($('#unreadToggle').prop('checked') && room.unreadCount === 0) {
                            $roomItem.hide();
                        } else {
                            $roomItem.show();
                        }

                    } else {
                        // 새로운 채팅방이 생성된 경우. 업데이트할 dom이 없다
                        const partnerProfileUrl = room.partnerProfileUrl || '/images/default-profile.png';
                        const unreadCountHtml = room.unreadCount > 0 ?
                            `<span class="unread-badge unread" style="margin-top: 5px;">${room.unreadCount}</span>` : '';

                        const newRoomHtml = `
                            <div class="chat-list-item"
                                 id="chat-room-${room.id}"
                                 data-unread-count="${room.unreadCount}"
                                 onclick="location.href='/chat/${room.id}'">
                                <img src="${partnerProfileUrl}" alt="상대방 사진">

                                <div style="flex-grow: 1; margin-right: 10px;">
                                    <div class="d-flex justify-content-between align-items-center w-100">
                                        <strong>${room.partnerNickName}</strong>
                                        <small class="last-message-time" style="color: #6c757d; font-size: 11px;">${formatDateTime(room.lastMessageCreatedAt)}</small>
                                    </div>
                                    <small class="last-message-content" style="color: #6c757d;">${room.lastMessage}</small>
                                </div>
                                ${unreadCountHtml}
                            </div>
                        `;
                        // 추가
                        $chatListContent.append(newRoomHtml);
                    }
                });

                // 안 읽은 메시지 수 업데이트
                updateTotalUnreadCountBadge(totalUnreadCount);
            },
            error: function (error) {
                console.error('[AJAX Reload ERROR]', error);
            }
        });
    }

    // 안 읽은 메시지 수 업데이트
    function updateTotalUnreadCountBadge(count) {
        const $badge = $('#totalUnreadCountBadge');

        if (count > 0) {
            $badge.text(count).show();
        } else {
            // 카운트 0이면 숨김
            $badge.hide();
        }
    }

    // 스크롤 아래로 내려주는 함수
    function scrollToBottom() {
        var $messageArea = $('#messageArea');

        if ($messageArea.length) {
            $messageArea.scrollTop($messageArea[0].scrollHeight);
        }
    }
</script>
</body>
</html>
